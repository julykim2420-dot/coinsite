<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Farm - 암호화폐 채굴대행 서비스</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; 
            color: #e6edf3;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://images.unsplash.com/photo-1639322537228-f710d846310a?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            filter: blur(5px) brightness(0.4); 
            z-index: -1;
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #161b22;
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid #30363d;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 400px;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            background-color: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #e6edf3;
        }
        .admin-table th, .admin-table td, .mining-farm-table th, .mining-farm-table td {
            padding: 12px;
            border-bottom: 1px solid #30363d;
        }
        .hidden-page {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <!-- Header -->
    <header class="p-4 md:p-6 flex items-center justify-between border-b border-gray-700 relative">
        <div class="flex items-center space-x-2">
            <svg class="w-8 h-8 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15.93v-2.88c0-.66.54-1.2 1.2-1.2s1.2.54 1.2 1.2v2.88c0 .66-.54 1.2-1.2 1.2s-1.2-.54-1.2-1.2zm1.2-4.8c-.66 0-1.2-.54-1.2-1.2v-2.88c0-.66.54-1.2 1.2-1.2s1.2.54 1.2 1.2v2.88c0 .66-.54 1.2-1.2 1.2zm1.2-4.8c-.66 0-1.2-.54-1.2-1.2V5.07c0-.66.54-1.2 1.2-1.2s1.2.54 1.2 1.2v2.88c0 .66-.54 1.2-1.2 1.2z"/>
            </svg>
            <span class="text-xl md:text-2xl font-bold">Coin Farm</span>
        </div>
        <nav class="hidden md:flex space-x-10">
            <button class="hover:text-yellow-400" data-page="home">HOME</button>
            <button class="hover:text-yellow-400" data-page="howToMine">채굴장 이용방법</button>
            <button class="hover:text-yellow-400" data-page="openMiningFarm">채굴장 개설</button>
            <button class="hover:text-yellow-400" data-page="myMiningFarm">내채굴장</button>
            <button class="hover:text-yellow-400" data-page="coinWallet">내지갑</button>
            <button class="hover:text-yellow-400" data-page="withdrawalRequest">출금요청</button>
            <button class="hover:text-yellow-400" data-page="customerService">고객센터</button>
        </nav>
        <div class="flex items-center space-x-2">
            <div id="desktop-auth-buttons" class="hidden md:flex items-center space-x-4">
                <span id="user-info" class="hidden text-gray-400 text-sm md:text-base"></span>
                <button id="login-btn" class="bg-gray-800 text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-700 transition">로그인</button>
                <button id="signup-btn" class="bg-yellow-500 text-gray-900 px-4 py-2 rounded-lg font-bold hover:bg-yellow-400 transition">회원가입</button>
                <button id="member-info-btn" class="hidden bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">회원정보</button>
                <button id="logout-btn" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">로그아웃</button>
            </div>
              <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 flex items-center space-x-2">
                <svg class="h-6 w-6" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
                <span>메뉴버튼</span>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="hidden md:hidden fixed inset-0 bg-gray-900 bg-opacity-95 z-50">
        <div class="flex justify-end p-4">
            <button id="close-mobile-menu">
                <svg class="h-8 w-8 text-white" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <nav class="flex flex-col items-center space-y-6 mt-10 text-xl">
            <button class="hover:text-yellow-400" data-page="home">HOME</button>
            <button class="hover:text-yellow-400" data-page="howToMine">채굴장 이용방법</button>
            <button class="hover:text-yellow-400" data-page="openMiningFarm">채굴장 개설</button>
            <button class="hover:text-yellow-400" data-page="myMiningFarm">내채굴장</button>
            <button class="hover:text-yellow-400" data-page="coinWallet">내지갑</button>
            <button class="hover:text-yellow-400" data-page="withdrawalRequest">출금요청</button>
            <button class="hover:text-yellow-400" data-page="customerService">고객센터</button>
            <div class="pt-6 border-t border-gray-700 w-3/4 text-center space-y-4">
                 <div id="mobile-auth-buttons">
                    <!-- Mobile auth buttons will be cloned here -->
                 </div>
            </div>
        </nav>
    </div>


    <!-- Main Content Wrapper -->
    <div id="content-container">
        <!-- Home Page -->
        <main id="home-page" class="container mx-auto p-4 md:p-8">
            <!-- Hero Section -->
            <section class="text-center py-16 md:py-10">
                <h1 class="text-3xl md:text-5xl font-bold leading-tight mb-12">
                    암호화폐 채굴 <span class="text-yellow-400"> Coin Farm </span>에서 시작하세요!
                </h1>
                <p class="text-gray-400 text-lg md:text-xl max-w-2xl mx-auto">
                    채굴테크 암호화폐 채굴대행 서비스를 통해 장비 관리부터 수익 정산까지
                <p class="text-gray-400 text-lg md:text-xl max-w-2xl mx-auto mb-8">    
                    신경쓰지 않고, 편안하게 안정적으로 수익을 창출하세요.
                </p>
                <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                </div>
            </section>

            <!-- About Section -->
            <section id="about-section" class="py-26">
                <div class="card p-8 rounded-xl">
                    <h2 class="text-3xl font-bold text-yellow-400 mb-8 text-center">사업 소개</h2>
                    <p class="text-lg text-gray-300 leading-relaxed mb-8">
                        코인 채굴의 난이도 상승에 따라 개인 채굴의 어려움 발생하고 있이며 채굴 풀(Mining Pool)로 채굴을 하며, 전문분석가가 선별한 수익성 있는 코인을 유동성 있게 채굴하여 고수익을 얻고있으며, 
                        당사에 채굴장을 보유하신 채굴장 등급에 따라 채굴 수익을 배분하는 시스템 입니다..
                    </p>
                    <p class="text-lg text-gray-300 leading-relaxed mb-6">
                        최신 채굴 장비와 코인의 동향을 전문적으로 파악하는 기술팀을 바탕으로 효율성을 극대화하고, 투명한 수익 분배 시스템을 통해 고객과의 신뢰를 최우선으로 생각합니다. 또한, 이용자의 편의를 위해 출금 요청 시 USDT테더로 지급하고 있습니다 
                    </p>
                </div>
            </section>

            <!-- Crypto Prices Section -->
            <section id="crypto-prices" class="py-16">
                <div class="relative flex justify-center items-center mb-8">
                    <h2 class="text-3xl font-bold">☆ 실시간 시세 차트 ☆</h2>
                    <button id="analyze-market-btn" class="absolute right-0 bg-blue-600 text-white font-bold py-2 px-6 rounded-full btn">
                        시장 분석
                    </button>
                </div>

                <!-- Real-time Charts Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Bitcoin Chart -->
                    <div class="h-[280px]">
                        <div class="tradingview-widget-container h-full">
                            <div class="tradingview-widget-container__widget h-full"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                              "symbol": "BITHUMB:BTCKRW",
                              "width": "100%",
                              "height": "100%",
                              "locale": "ko",
                              "dateRange": "1D",
                              "colorTheme": "dark",
                              "isTransparent": true,
                              "autosize": false,
                              "largeChartUrl": ""
                            }
                            </script>
                        </div>
                    </div>
                    <!-- Ethereum Chart -->
                    <div class="h-[280px]">
                        <div class="tradingview-widget-container h-full">
                            <div class="tradingview-widget-container__widget h-full"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                              "symbol": "BITHUMB:ETHKRW",
                              "width": "100%",
                              "height": "100%",
                              "locale": "ko",
                              "dateRange": "1D",
                              "colorTheme": "dark",
                              "isTransparent": true,
                              "autosize": false,
                              "largeChartUrl": ""
                            }
                            </script>
                        </div>
                    </div>
                    <!-- Ripple Chart -->
                    <div class="h-[280px]">
                        <div class="tradingview-widget-container h-full">
                            <div class="tradingview-widget-container__widget h-full"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                              "symbol": "BITHUMB:XRPKRW",
                              "width": "100%",
                              "height": "100%",
                              "locale": "ko",
                              "dateRange": "1D",
                              "colorTheme": "dark",
                              "isTransparent": true,
                              "autosize": false,
                              "largeChartUrl": ""
                            }
                            </script>
                        </div>
                    </div>
                    <!-- Solana Chart -->
                    <div class="h-[280px]">
                        <div class="tradingview-widget-container h-full">
                            <div class="tradingview-widget-container__widget h-full"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                              "symbol": "BITHUMB:SOLKRW",
                              "width": "100%",
                              "height": "100%",
                              "locale": "ko",
                              "dateRange": "1D",
                              "colorTheme": "dark",
                              "isTransparent": true,
                              "autosize": false,
                              "largeChartUrl": ""
                            }
                            </script>
                        </div>
                    </div>
                    <!-- Tether Chart -->
                    <div class="h-[280px]">
                        <div class="tradingview-widget-container h-full">
                            <div class="tradingview-widget-container__widget h-full"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                              "symbol": "BITHUMB:USDTKRW",
                              "width": "100%",
                              "height": "100%",
                              "locale": "ko",
                              "dateRange": "1D",
                              "colorTheme": "dark",
                              "isTransparent": true,
                              "autosize": false,
                              "largeChartUrl": ""
                            }
                            </script>
                        </div>
                    </div>
                    <!-- Dogecoin Chart -->
                    <div class="h-[280px]">
                        <div class="tradingview-widget-container h-full">
                            <div class="tradingview-widget-container__widget h-full"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                              "symbol": "BITHUMB:DOGEKRW",
                              "width": "100%",
                              "height": "100%",
                              "locale": "ko",
                              "dateRange": "1D",
                              "colorTheme": "dark",
                              "isTransparent": true,
                              "autosize": false,
                              "largeChartUrl": ""
                            }
                            </script>
                        </div>
                    </div>
                </div>

                <!-- Crypto analysis result section -->
                <div id="crypto-analysis-result" class="card p-6 mt-8 rounded-xl hidden">
                    <h3 class="text-xl font-bold text-yellow-400 mb-2">시장 분석 결과</h3>
                    <p id="analysis-text" class="text-gray-300"></p>
                    <div id="analysis-loader" class="flex justify-center mt-4 hidden">
                        <div class="loader"></div>
                    </div>
                </div>
            </section>

            <!-- Mining Plans Section -->
            <section id="plans" class="py-6">
                <h2 class="text-3xl font-bold text-center mb-8">☆ 채굴장 등급 ☆</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Silver Plan -->
                    <div class="card p-8 rounded-xl text-center border-2 border-yellow-400">
                        <h3 class="text-2xl font-bold text-yellow-400 mb-2">SILVER MINES</h3>
                        <p class="text-lg text-red-400 mb-2">₩5,000,000</p>
                        <p class="text-gray-300 mb-6">암호화폐 채굴을 처음 시작하는 초급자를 위한 등급입니다. 안정적인 채굴 시스템을 통해 부담 없이 시작할 수 있습니다.</p>
                    </div>
                    <!-- Gold Plan -->
                    <div class="card p-8 rounded-xl text-center border-2 border-yellow-400">
                        <h3 class="text-2xl font-bold text-yellow-400 mb-2">GOLD MINES</h3>
                        <p class="text-lg text-red-400 mb-2">₩10,000,000</p>
                        <p class="text-gray-300 mb-6">더 높은 수익률을 목표로 하는 중급 채굴자에게 적합합니다. 효율적인 장비로 채굴 속도를 향상시킵니다.</p>
                    </div>
                    <!-- Diamond Plan -->
                    <div class="card p-8 rounded-xl text-center border-2 border-yellow-400">
                        <h3 class="text-2xl font-bold text-yellow-400 mb-2">DIAMOND MINES</h3>
                        <p class="text-lg text-red-400 mb-2">₩15,000,000</p>
                        <p class="text-gray-300 mb-6">최고의 성능과 최대 수익을 원하는 전문가를 위한 등급입니다. 프리미엄 장비로 최상의 채굴 효율을 경험하세요.</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- How to Mine Page -->
        <main id="howToMine-page" class="container mx-auto p-4 md:p-8 py-16 hidden-page">
            <h1 class="text-3xl md:text-5xl font-bold text-center text-yellow-400 mb-8">채굴장 이용방법</h1>
            <div class="card p-8 rounded-xl max-w-3xl mx-auto space-y-6">
                <p class="text-lg text-gray-300">
                    저희 채굴장 이용은 아주 간단합니다. 아래 단계를 따라 암호화폐 채굴을 시작해 보세요.
                </p>
                <div class="space-y-4">
                    <div class="flex items-start space-x-4">
                        <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-yellow-500 text-gray-900 font-bold">1</span>
                        <div>
                            <h3 class="font-bold text-xl">회원가입 및 로그인</h3>
                            <p class="text-gray-400">
                                먼저 웹사이트 상단에서 회원가입을 하고 로그인합니다.
                            </p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-yellow-500 text-gray-900 font-bold">2</span>
                        <div>
                            <h3 class="font-bold text-xl">채굴장 개설 및 채굴</h3>
                            <p class="text-gray-400">
                                1-초기자금 부담없이 시작하는 실버 채굴장부터 최대 수익성을 보장하는 다이아몬드 채굴장까지, 원하시는 채굴장과 수량을 선택하고 구매신청을 한다.
                            </p>
                            <p class="text-gray-400">    
                                2-고객센터에 개설관련을 선택하고 채굴장 개설 입금계좌를 문의 및 결재 후 내 채굴장에 구매한 채굴장이 활성화 되면 채굴시작을 누른다.
                            </p>
                        </div>
                    </div>
                    <div class="flex items-start space-x-4">
                        <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-yellow-500 text-gray-900 font-bold">3</span>
                        <div>
                            <h3 class="font-bold text-xl">출금 요청</h3>
                            <p class="text-gray-400">
                                1-채굴이 시작되면 보유하고 있는 모든 채굴장의 코인이 USDT테더로 환산되어 코인 지갑으로 실시간 저장됩니다.
                            </p>
                            <p class="text-gray-400">
                                2-출금을 할때는 출금요청 페이지에서 양식에 맞게 작성후 고객센터에 출금관련을 선택하고 출금 금액을 기입하고 요청을 보내면 된다.   (최소 출금액은 35 USDT입니다.)
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Open Mining Farm Page -->
        <main id="openMiningFarm-page" class="container mx-auto p-4 md:p-8 py-16 hidden-page">
            <h1 class="text-3xl md:text-5xl font-bold text-center text-yellow-400 mb-8">채굴장 개설</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                <!-- Silver Plan -->
                <div class="card p-8 rounded-xl text-center border-2 border-yellow-400">
                    <h3 class="text-2xl font-bold text-yellow-400 mb-2">SILVER MINES</h3>
                    <p class="text-lg text-red-400 mb-2">₩5,000,000</p>
                    <p class="text-gray-400 text-sm mb-2">입문자에게 추천!</p>
                    <p class="text-gray-400 text-sm mb-6">안정적인 수익을 체험.</p>
                    <div class="flex flex-col items-center space-y-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-400">수량:</span>
                            <input type="number" value="1" min="1" class="w-16 form-input text-center purchase-quantity" />
                        </div>
                        <button class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-full btn purchase-btn" data-type="SILVER MINES" data-price="5000000">
                            구매하기
                        </button>
                    </div>
                </div>
                <!-- Gold Plan -->
                <div class="card p-8 rounded-xl text-center border-2 border-yellow-400">
                    <h3 class="text-2xl font-bold text-yellow-400 mb-2">GOLD MINES</h3>
                    <p class="text-lg text-red-400 mb-2">₩10,000,000</p>
                    <p class="text-gray-400 text-sm mb-2">중급자에게 적합!</p>
                    <p class="text-gray-400 text-sm mb-6">빨라진 채굴속도와 향상된 수익.</p>
                    <div class="flex flex-col items-center space-y-4">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-400">수량:</span>
                            <input type="number" value="1" min="1" class="w-16 form-input text-center purchase-quantity" />
                        </div>
                        <button class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-full btn purchase-btn" data-type="GOLD MINES" data-price="10000000">
                            구매하기
                        </button>
                    </div>
                </div>
                <!-- Diamond Plan -->
                <div class="card p-8 rounded-xl text-center border-2 border-yellow-400">
                    <h3 class="text-2xl font-bold text-yellow-400 mb-2">DIAMOND MINES</h3>
                    <p class="text-lg text-red-400 mb-2">₩15,000,000</p>
                    <p class="text-gray-400 text-sm mb-2">높은 수익을 위한 등급!</p>
                    <p class="text-gray-400 text-sm mb-6">최고의 장비로 최대 수익.</p>
                    <div class="flex flex-col items-center space-y-4">
                        <div class="flex items-center space-x-1">
                            <span class="text-gray-400">수량:</span>
                            <input type="number" value="1" min="1" class="w-16 form-input text-center purchase-quantity" />
                        </div>
                        <button class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-full btn purchase-btn" data-type="DIAMOND MINES" data-price="15000000">
                            구매하기
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- My Mining Farm Page -->
        <main id="myMiningFarm-page" class="container mx-auto p-4 md:p-8 py-16 hidden-page">
            <h1 class="text-3xl md:text-5xl font-bold text-center text-yellow-400 mb-8">내 채굴장 현황</h1>
            <div class="card p-8 rounded-xl max-w-5xl mx-auto space-y-6">
                <p class="text-lg text-gray-300">
                    회원님이 보유한 채굴장 현황입니다.
                </p>
                <div id="my-mining-farms-container" class="space-y-8">
                    <p class="text-center text-gray-500">채굴장 데이터를 불러오는 중...</p>
                </div>
            </div>
        </main>
        
        <!-- Coin Wallet Page -->
        <main id="coinWallet-page" class="container mx-auto p-4 md:p-8 py-16 hidden-page">
            <h1 class="text-3xl md:text-5xl font-bold text-center text-yellow-400 mb-8">코인 지갑</h1>
            <div class="card p-8 rounded-xl max-w-2xl mx-auto space-y-6">
                <div class="text-center">
                    <p class="text-lg text-gray-400">총 보유 채굴량</p>
                    <h2 id="total-mined-usdt" class="text-5xl font-bold text-green-400 mt-2">0.000000 USDT</h2>
                    <p id="krw-equivalent" class="text-gray-400 mt-2">(약 ₩0)</p>
                </div>
            </div>
        </main>

        <!-- Withdrawal Request Page -->
        <main id="withdrawalRequest-page" class="container mx-auto p-4 md:p-8 py-16 hidden-page">
            <h1 class="text-3xl md:text-5xl font-bold text-center text-yellow-400 mb-8">출금 요청</h1>
            <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
                <!-- Left Column: Withdrawal Form -->
                <div class="lg:w-7/12 card p-8 rounded-xl space-y-6">
                    <p class="text-lg text-gray-300">
                        출금 요청을 하려면 아래 정보를 입력해주세요.
                    </p>
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-gray-400">사용 가능 USDT:</p>
                        <span id="available-usdt" class="text-xl font-bold text-green-400">0.000000 USDT</span>
                    </div>
                    <form id="withdrawal-form" class="space-y-4">
                        <div>
                            <label for="withdrawal-amount" class="block text-gray-400 mb-1">출금 금액 (USDT)</label>
                            <input type="number" id="withdrawal-amount" class="form-input" placeholder="최소 35 USDT" min="35" step="0.000001" required>
                        </div>
                        <div>
                            <label for="wallet-address" class="block text-gray-400 mb-1">지갑 주소</label>
                            <input type="text" id="wallet-address" class="form-input" placeholder="출금받을 지갑 주소 입력" required>
                        </div>
                        <button type="submit" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg btn">
                            출금 요청하기
                        </button>
                    </form>
                </div>
                <!-- Right Column: Withdrawal History -->
                <div class="lg:w-5/12 card p-8 rounded-xl space-y-4">
                    <h2 class="text-2xl font-bold text-yellow-400">출금 요청 내역</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left admin-table">
                            <thead>
                                <tr class="text-gray-400 uppercase text-sm">
                                    <th class="font-normal">요청일</th>
                                    <th class="font-normal">금액 (USDT)</th>
                                    <th class="font-normal">상태</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawal-history-table-body">
                                <tr><td colspan="3" class="text-center text-gray-500">출금 요청 내역을 불러오는 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Customer Service Page -->
        <main id="customerService-page" class="container mx-auto p-4 md:p-8 py-16 hidden-page">
            <h1 class="text-3xl md:text-5xl font-bold text-center text-yellow-400 mb-8">고객 센터</h1>
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-end mb-6">
                    <button id="show-inquiry-form-btn" class="bg-yellow-500 text-gray-900 font-bold py-2 px-6 rounded-lg btn hidden">문의하기</button>
                </div>

                <!-- New Inquiry Form -->
                <div id="inquiry-form-container" class="card p-8 rounded-xl mb-8 hidden">
                    <h2 class="text-2xl font-bold mb-4">새 문의 작성</h2>
                    <form id="inquiry-form" class="space-y-4">
                        <div>
                            <label for="inquiry-category" class="block text-gray-400 mb-1">카테고리</label>
                            <select id="inquiry-category" class="form-input" required>
                                <option value="" disabled selected>카테고리를 선택하세요</option>
                                <option value="이용관련">이용관련</option>
                                <option value="개설관련">개설관련</option>
                                <option value="출금관련">출금관련</option>
                                <option value="기타관련">기타관련</option>
                            </select>
                        </div>
                        <div>
                            <label for="inquiry-title" class="block text-gray-400 mb-1">제목</label>
                            <input type="text" id="inquiry-title" class="form-input" required>
                        </div>
                        <div>
                            <label for="inquiry-question" class="block text-gray-400 mb-1">내용</label>
                            <textarea id="inquiry-question" rows="5" class="form-input" required></textarea>
                        </div>
                        <div class="flex justify-end space-x-4">
                             <button type="button" id="cancel-inquiry-btn" class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg btn">취소</button>
                            <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg btn">제출하기</button>
                        </div>
                    </form>
                </div>
                
                <!-- Inquiries List -->
                <div id="inquiries-list" class="space-y-4">
                    <p class="text-center text-gray-500">로그인 후 문의 내역을 확인하거나 새 문의를 작성할 수 있습니다.</p>
                </div>
            </div>
        </main>


        <!-- Admin Page -->
        <main id="admin-page" class="container mx-auto p-4 md:p-8 py-16 hidden-page">
            <h1 class="text-3xl md:text-5xl font-bold text-center text-yellow-400 mb-8">관리자 대시보드</h1>
            
            <div id="admin-dashboard-area">
                <div class="card p-4 rounded-xl mb-8 flex justify-between items-center overflow-x-auto">
                    <button class="flex-shrink-0 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition" data-section="users">가입회원 정보</button>
                    <button class="flex-shrink-0 px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700 transition" data-section="mining">사용자 채굴현황</button>
                    <button class="flex-shrink-0 px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700 transition" data-section="purchase">채굴장 개설요청</button>
                    <button class="flex-shrink-0 px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700 transition" data-section="withdrawals">출금요청 내역</button>
                    <button class="flex-shrink-0 px-4 py-2 bg-gray-800 text-gray-300 rounded-lg hover:bg-gray-700 transition" data-section="inquiries">고객센터 문의</button>
                </div>

                <div id="mining-input-section" class="card p-8 rounded-xl mb-8">
                    <h2 class="text-2xl font-bold mb-4">등급별 채굴량 입력 (분당 USDT)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="silver-rate" class="block text-gray-400">SILVER MINES (USDT)</label>
                            <input type="number" id="silver-rate" class="form-input mt-1" placeholder="분당 채굴량 입력" step="0.000001">
                        </div>
                        <div>
                            <label for="gold-rate" class="block text-gray-400">GOLD MINES (USDT)</label>
                            <input type="number" id="gold-rate" class="form-input mt-1" placeholder="분당 채굴량 입력" step="0.000001">
                        </div>
                        <div>
                            <label for="diamond-rate" class="block text-gray-400">DIAMOND MINES (USDT)</label>
                            <input type="number" id="diamond-rate" class="form-input mt-1" placeholder="분당 채굴량 입력" step="0.000001">
                        </div>
                    </div>
                    <button id="update-mining-rate-btn" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg btn">채굴량 업데이트</button>
                    <p id="mining-rate-message" class="text-green-400 text-center mt-4 hidden"></p>
                </div>
                
                <section id="users-section">
                    <h2 class="text-2xl font-bold mb-4">가입회원 정보</h2>
                    <div class="mb-4 flex items-center gap-2">
                        <select id="user-search-category" class="form-input w-48 bg-gray-800 border-gray-600">
                            <option value="id">가입번호 (UID)</option>
                            <option value="username">사용자 아이디</option>
                        </select>
                        <input type="text" id="user-search-input" class="form-input flex-grow" placeholder="검색어 입력...">
                        <button id="user-search-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg btn">검색</button>
                    </div>
                    <div class="card p-8 rounded-xl">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left admin-table">
                                <thead>
                                    <tr class="text-gray-400 uppercase text-sm">
                                        <th class="font-normal">가입번호 (UID)</th>
                                        <th class="font-normal">사용자 아이디</th>
                                        <th class="font-normal">전화번호</th>
                                        <th class="font-normal">가입일</th>
                                        <th class="font-normal">관리</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <tr><td colspan="5" class="text-center text-gray-500">데이터를 불러오는 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="mining-section" class="hidden-page">
                    <h2 class="text-2xl font-bold mb-4">사용자 채굴현황</h2>
                    <div class="card p-8 rounded-xl">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left admin-table">
                                <thead>
                                    <tr class="text-gray-400 uppercase text-sm">
                                        <th class="font-normal">가입번호 (UID)</th>
                                        <th class="font-normal">사용자 아이디</th>
                                        <th class="font-normal">보유 채굴장</th>
                                        <th class="font-normal">총 채굴량 (USDT)</th>
                                    </tr>
                                </thead>
                                <tbody id="mining-table-body">
                                    <tr><td colspan="4" class="text-center text-gray-500">데이터를 불러오는 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="purchase-section" class="hidden-page">
                    <h2 class="text-2xl font-bold mb-4">채굴장 개설요청</h2>
                    <div class="card p-8 rounded-xl">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left admin-table">
                                <thead>
                                    <tr class="text-gray-400 uppercase text-sm">
                                        <th class="font-normal">가입번호 (UID)</th>
                                        <th class="font-normal">사용자 아이디</th>
                                        <th class="font-normal">신청 등급</th>
                                        <th class="font-normal">수량</th>
                                        <th class="font-normal">상태</th>
                                        <th class="font-normal">관리</th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-table-body">
                                    <tr><td colspan="6" class="text-center text-gray-500">데이터를 불러오는 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section id="withdrawals-section" class="hidden-page">
                    <h2 class="text-2xl font-bold mb-4">출금요청 내역</h2>
                    <div class="card p-8 rounded-xl">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left admin-table">
                                <thead>
                                    <tr class="text-gray-400 uppercase text-sm">
                                        <th class="font-normal">가입번호 (UID)</th>
                                        <th class="font-normal">사용자 아이디</th>
                                        <th class="font-normal">요청 금액 (USDT)</th>
                                        <th class="font-normal">지갑 주소</th>
                                        <th class="font-normal">상태</th>
                                        <th class="font-normal">요청일</th>
                                        <th class="font-normal">관리</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawals-table-body">
                                    <tr><td colspan="7" class="text-center text-gray-500">데이터를 불러오는 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <section id="inquiries-section" class="hidden-page">
                    <h2 class="text-2xl font-bold mb-4">고객센터 문의</h2>
                    <div class="mb-4 flex flex-wrap gap-2" id="admin-inquiry-filters">
                        <button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg btn" data-category="전체">전체</button>
                        <button class="bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg btn" data-category="이용관련">이용관련</button>
                        <button class="bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg btn" data-category="개설관련">개설관련</button>
                        <button class="bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg btn" data-category="출금관련">출금관련</button>
                        <button class="bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-lg btn" data-category="기타관련">기타관련</button>
                    </div>
                    <div id="admin-inquiries-list" class="space-y-4">
                       <p class="text-center text-gray-500">데이터를 불러오는 중...</p>
                    </div>
                </section>
            </div>
        </main>

    </div>

    <!-- Footer -->
    <footer class="text-center py-6 border-t border-gray-700">
        <p class="text-gray-400 text-sm">
            © 2025 LIVIKA LP. All rights reserved.
        </p>
        <p class="text-gray-500 text-xs mt-1">
            * Crypto currency mining은 외국인을 위한 서비스를 제공하지 않습니다.
        </p>
        <button id="admin-page-link" class="text-blue-400 hover:underline mt-2">관리자 페이지</button>
    </footer>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-yellow-400">로그인</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <input id="login-username" type="text" placeholder="사용자 아이디" class="form-input" required>
                <input id="login-password" type="password" placeholder="비밀번호" class="form-input" required>
                <button type="submit" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg btn">로그인</button>
            </form>
            <!-- Signup Form -->
            <form id="signup-form" class="space-y-4 hidden">
                <input id="signup-username" type="text" placeholder="사용자 아이디" class="form-input" required>
                <input id="signup-password" type="password" placeholder="비밀번호" class="form-input" required>
                <input id="signup-password-confirm" type="password" placeholder="비밀번호 확인" class="form-input" required>
                <input id="signup-phone" type="tel" placeholder="휴대전화번호" class="form-input" required>
                <button type="submit" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg btn">가입하기</button>
            </form>
            <p id="modal-message" class="text-center text-red-400 mt-4 hidden"></p>
        </div>
    </div>

    <!-- User Details Modal (for Admin and Member Info) -->
    <div id="user-details-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xl font-bold text-yellow-400">회원 상세 정보</h3>
                <button id="close-user-details-modal" class="text-gray-400 hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <div id="user-details-content" class="space-y-3 text-gray-300 pr-2">
                <!-- Basic Info -->
                <div class="border-b border-gray-700 pb-2">
                    <h4 class="text-lg font-bold text-yellow-400 mb-1">기본 정보</h4>
                    <p class="text-sm"><strong>가입번호 (UID):</strong> <span id="detail-uid" class="text-yellow-400"></span></p>
                    <p class="text-sm"><strong>사용자 아이디:</strong> <span id="detail-username"></span></p>
                    <p class="text-sm"><strong>비밀번호:</strong> <span id="detail-password"></span></p>
                    <p class="text-sm"><strong>전화번호:</strong> <span id="detail-phone"></span></p>
                    <p class="text-sm"><strong>가입일:</strong> <span id="detail-signup-date"></span></p>
                </div>
                <!-- Mining Info -->
                <div class="border-b border-gray-700 pb-2">
                    <h4 class="text-lg font-bold text-yellow-400 mb-1">채굴장 현황</h4>
                    <div id="detail-farms"></div>
                </div>
                <!-- Coin Info -->
                <div class="border-b border-gray-700 pb-2">
                    <h4 class="text-lg font-bold text-yellow-400 mb-1">코인 현황 (USDT)</h4>
                    <p class="text-sm"><strong>누적 채굴량:</strong> <span id="detail-total-mined"></span></p>
                    <p class="text-sm"><strong>누적 출금액 (승인 완료):</strong> <span id="detail-total-withdrawn" class="font-bold text-red-400"></span></p>
                    <p class="font-bold text-green-400 text-base"><strong>잔여 코인:</strong> <span id="detail-balance"></span></p>
                </div>
                <!-- Password Change Section (only visible for Admin view of other users) -->
                <div id="password-change-section">
                    <h4 class="text-lg font-bold text-yellow-400 mb-1">비밀번호 변경 (관리자용)</h4>
                     <div class="space-y-2">
                        <input type="hidden" id="password-change-user-uid">
                        <input type="password" id="new-password" class="form-input text-sm" placeholder="새 비밀번호">
                        <input type="password" id="confirm-new-password" class="form-input text-sm" placeholder="새 비밀번호 확인">
                        <button id="change-password-btn" class="w-full bg-yellow-500 text-gray-900 font-bold py-2 rounded-lg btn">변경하기</button>
                        <p id="password-change-message" class="text-center text-xs mt-2 hidden"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="message-modal-title" class="text-2xl font-bold text-yellow-400">알림</h3>
                <button id="message-modal-close" class="text-gray-400 hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <p id="message-modal-content" class="text-gray-300 text-center"></p>
            <div class="mt-6 text-center">
                <button id="message-modal-confirm-btn" class="bg-yellow-500 text-gray-900 font-bold py-2 px-8 rounded-lg btn">확인</button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-400">관리자 로그인</h3>
                <button id="close-admin-modal" class="text-gray-400 hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>
            <form id="admin-login-form" class="space-y-4">
                <input id="admin-login-username" type="text" placeholder="관리자 아이디" class="form-input" required>
                <input id="admin-login-password" type="password" placeholder="비밀번호" class="form-input" required>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg btn">로그인</button>
            </form>
            <p id="admin-modal-message" class="text-center text-red-400 mt-4 hidden"></p>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports and Initialization ---
        // All necessary imports are now consolidated in this single module script for correct scoping.
        import { initializeApp as fbInitializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc, 
            getDocs, 
            runTransaction,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables provided by the Canvas environment (now local constants)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Local variables for Firebase instances
        let app = null;
        let db = null;
        let auth = null;

        // Firebase Collection and Document References (defined after 'db' is assigned)
        let USERS_COLLECTION_REF = null;
        let CONFIG_DOC_REF = null;
        
        // Initializing Firebase and assigning local variables
        if (Object.keys(firebaseConfig).length > 0) {
            app = fbInitializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Define local references after successful db initialization
            USERS_COLLECTION_REF = collection(db, `artifacts/${appId}/public/data/users`);
            CONFIG_DOC_REF = doc(db, `artifacts/${appId}/public/data/config/mining_rates`);

        } else {
            console.error("Firebase configuration is missing.");
        }
        // --- End of Firebase Imports and Initialization ---


        const pages = ['home', 'howToMine', 'openMiningFarm', 'myMiningFarm', 'coinWallet', 'withdrawalRequest', 'admin', 'customerService'];
        const pageElements = pages.reduce((acc, page) => {
            acc[page] = document.getElementById(`${page}-page`);
            return acc;
        }, {});
        
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfoSpan = document.getElementById('user-info');
        const authModal = document.getElementById('auth-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const adminLoginModal = document.getElementById('admin-login-modal');
        const closeAdminModalBtn = document.getElementById('close-admin-modal');
        const adminLoginForm = document.getElementById('admin-login-form');
        const userDetailsModal = document.getElementById('user-details-modal');
        const closeUserDetailsModalBtn = document.getElementById('close-user-details-modal');
        const memberInfoBtn = document.getElementById('member-info-btn');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenu = document.getElementById('close-mobile-menu');
        const adminSections = ['users', 'mining', 'purchase', 'withdrawals', 'inquiries'];

        let currentUser = null; // Stores the user data { uid, id, username, isAdmin, ... }
        let currentFirebaseUser = null; // Stores the Firebase Auth user object
        let globalMiningInterval = null; 
        let activePage = 'home'; 

        // Global State Management (Updated by Firestore Listeners)
        let state = {
            users: [],
            purchases: [],
            withdrawals: [],
            miningFarms: [],
            inquiries: [],
            miningRates: { 'SILVER MINES': 0, 'GOLD MINES': 0, 'DIAMOND MINES': 0 }
        };

        const MINING_RATE_MULTIPLIER = 1; // 1 second interval, so we use 1 here for calculation

        // --- Utility Functions ---

        const formatDateTime = (date) => {
            if (!date) return '미기록';
            const d = new Date(date);
            return `${d.toLocaleDateString('ko-KR')} ${d.toLocaleTimeString('ko-KR')}`;
        };
        
        const formatDate = (date) => {
            if (!date) return '미기록';
            return new Date(date).toLocaleDateString('ko-KR');
        };

        const formatDuration = (milliseconds) => {
            if (milliseconds < 0) return '0초';
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            let parts = [];
            if (days > 0) parts.push(`${days}일`);
            if (hours % 24 > 0) parts.push(`${hours % 24}시간`);
            if (minutes % 60 > 0) parts.push(`${minutes % 60}분`);
            if (seconds % 60 > 0) parts.push(`${seconds % 60}초`);
            
            return parts.length > 0 ? parts.join(' ') : '0초';
        };

        const generateDisplayUserId = (uid) => {
             // Use Firebase UID as the base for a unique, deterministic display ID
             return uid.substring(0, 8).toUpperCase();
        };

        // Show a custom message modal
        const showMessageModal = (title, message) => {
            const messageModal = document.getElementById('message-modal');
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-content').textContent = message;
            messageModal.style.display = 'flex';
        };

        const closeMessageModal = () => {
            document.getElementById('message-modal').style.display = 'none';
        };

        // --- Firestore Data Access Functions (Used by Listeners and Write Ops) ---

        const getPrivateCollectionRef = (collectionName, uid) => {
            if (!uid) return null;
            return collection(db, `artifacts/${appId}/users/${uid}/${collectionName}`);
        };

        const getGlobalCollectionRef = (collectionName) => {
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        };

        // --- Auth & UI Management ---

        const updateAuthUI = () => {
            const isLoggedIn = !!currentUser;
            const desktopAuthContainer = document.getElementById('desktop-auth-buttons');
            const mobileAuthContainer = document.getElementById('mobile-auth-buttons');
            
            // Clear previous buttons and clone/re-render
            mobileAuthContainer.innerHTML = '';
            
            Array.from(desktopAuthContainer.children).forEach(node => {
                const clone = node.cloneNode(true);
                clone.id = `mobile-${node.id}`; 
                clone.classList.remove('hidden', 'md:flex');
                clone.classList.add('w-full', 'block');
                mobileAuthContainer.appendChild(clone);
            });
            
            // Re-fetch elements after cloning
            const mobileLoginBtn = document.getElementById('mobile-login-btn');
            const mobileSignupBtn = document.getElementById('mobile-signup-btn');
            const mobileMemberInfoBtn = document.getElementById('mobile-member-info-btn');
            const mobileLogoutBtn = document.getElementById('mobile-logout-btn');
            const mobileUserInfo = document.getElementById('mobile-user-info');
            
            const adminNavButtons = document.querySelectorAll('nav button[data-page="admin"]');
            
            if (isLoggedIn) {
                loginBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                memberInfoBtn.classList.remove('hidden');
                userInfoSpan.classList.remove('hidden');
                userInfoSpan.textContent = `${currentUser.username}님 (${currentUser.isAdmin ? '관리자' : '일반'})`;

                // Mobile view
                if(mobileLoginBtn) mobileLoginBtn.classList.add('hidden');
                if(mobileSignupBtn) mobileSignupBtn.classList.add('hidden');
                if(mobileLogoutBtn) mobileLogoutBtn.classList.remove('hidden');
                if(mobileMemberInfoBtn) mobileMemberInfoBtn.classList.remove('hidden');
                if(mobileUserInfo) { mobileUserInfo.classList.remove('hidden'); mobileUserInfo.textContent = `${currentUser.username}님`; }
            } else {
                loginBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                memberInfoBtn.classList.add('hidden');
                userInfoSpan.classList.add('hidden');

                // Mobile view
                if(mobileLoginBtn) mobileLoginBtn.classList.remove('hidden');
                if(mobileSignupBtn) mobileSignupBtn.classList.remove('hidden');
                if(mobileLogoutBtn) mobileLogoutBtn.classList.add('hidden');
                if(mobileMemberInfoBtn) mobileMemberInfoBtn.classList.add('hidden');
                if(mobileUserInfo) mobileUserInfo.classList.add('hidden');
            }

            // Re-attach listeners for cloned mobile buttons
            if (mobileLoginBtn) mobileLoginBtn.onclick = () => { mobileMenu.classList.add('hidden'); loginBtn.click(); };
            if (mobileSignupBtn) mobileSignupBtn.onclick = () => { mobileMenu.classList.add('hidden'); signupBtn.click(); };
            if (mobileMemberInfoBtn) mobileMemberInfoBtn.onclick = () => { mobileMenu.classList.add('hidden'); memberInfoBtn.click(); };
            if (mobileLogoutBtn) mobileLogoutBtn.onclick = () => { mobileMenu.classList.add('hidden'); logoutBtn.click(); };

            // Admin link visibility (admin page link is only in footer, which is permanent)
        };
        
        const loginUser = async (username, password, isAdminLogin = false) => {
            const usersRef = USERS_COLLECTION_REF;
            const q = query(usersRef, where("username", "==", username), where("password", "==", password));
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    return { success: false, message: '아이디 또는 비밀번호가 올바르지 않습니다.' };
                }

                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                
                if (isAdminLogin && !userData.isAdmin) {
                    return { success: false, message: '관리자 계정이 아닙니다.' };
                }
                
                // If a non-admin user tries to access the admin portal with valid credentials
                if (!isAdminLogin && userData.isAdmin) {
                    return { success: false, message: '관리자 계정은 일반 로그인으로 접근할 수 없습니다.' };
                }

                // If the user's current Firebase UID doesn't match the stored UID (shouldn't happen often)
                // We trust the Firebase auth UID in the end. For this scenario, we just log them in 
                // and trust the Firestore document data.
                
                currentUser = { ...userData, uid: userDoc.id };
                updateAuthUI();
                startGlobalMiningInterval();
                return { success: true, message: '로그인 성공', user: currentUser };
                
            } catch (error) {
                console.error("Login Error:", error);
                return { success: false, message: `로그인 중 오류 발생: ${error.message}` };
            }
        };


        // --- Firestore Listeners & State Management ---
        
        let userFarmsListener = null;
        let userWithdrawalsListener = null;
        let userInquiriesListener = null;
        let globalUsersListener = null;
        let globalPurchasesListener = null;
        let globalWithdrawalsListener = null;
        let globalInquiriesListener = null;
        let configListener = null;
        
        const stopAllListeners = () => {
            [userFarmsListener, userWithdrawalsListener, userInquiriesListener, globalUsersListener, globalPurchasesListener, globalWithdrawalsListener, globalInquiriesListener, configListener].forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            userFarmsListener = userWithdrawalsListener = userInquiriesListener = globalUsersListener = globalPurchasesListener = globalWithdrawalsListener = globalInquiriesListener = configListener = null;
        };

        const setupGlobalListeners = () => {
             // 1. Mining Rates Config Listener (Global)
            if (!configListener && CONFIG_DOC_REF) {
                configListener = onSnapshot(CONFIG_DOC_REF, (docSnapshot) => {
                    const data = docSnapshot.data();
                    if (data) {
                        state.miningRates = {
                            'SILVER MINES': data.silverRate || 0,
                            'GOLD MINES': data.goldRate || 0,
                            'DIAMOND MINES': data.diamondRate || 0
                        };
                        console.log("Mining Rates Updated:", state.miningRates);
                        // Update admin rate inputs if admin page is active
                        if (currentUser && currentUser.isAdmin && activePage === 'admin') {
                            document.getElementById('silver-rate').value = state.miningRates['SILVER MINES'];
                            document.getElementById('gold-rate').value = state.miningRates['GOLD MINES'];
                            document.getElementById('diamond-rate').value = state.miningRates['DIAMOND MINES'];
                        }
                    }
                }, (error) => console.error("Config Listener Error:", error));
            }
            
            // 2. Global Users Listener (for Admin table)
            if (!globalUsersListener && USERS_COLLECTION_REF) {
                globalUsersListener = onSnapshot(USERS_COLLECTION_REF, (snapshot) => {
                    state.users = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                    if (currentUser && currentUser.isAdmin && activePage === 'admin') renderAdminUsers();
                    console.log("Users Updated:", state.users.length);
                }, (error) => console.error("Global Users Listener Error:", error));
            }

            // 3. Global Purchases Listener (for Admin purchase requests)
            if (!globalPurchasesListener && db) {
                const purchasesRef = getGlobalCollectionRef('purchases');
                globalPurchasesListener = onSnapshot(purchasesRef, (snapshot) => {
                    state.purchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentUser && currentUser.isAdmin && activePage === 'admin') renderAdminPurchases();
                }, (error) => console.error("Global Purchases Listener Error:", error));
            }

            // 4. Global Withdrawals Listener (for Admin view)
            if (!globalWithdrawalsListener && db) {
                const withdrawalsRef = getGlobalCollectionRef('withdrawals');
                globalWithdrawalsListener = onSnapshot(withdrawalsRef, (snapshot) => {
                    state.withdrawals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentUser && currentUser.isAdmin && activePage === 'admin') renderAdminWithdrawals();
                }, (error) => console.error("Global Withdrawals Listener Error:", error));
            }
            
            // 5. Global Inquiries Listener (for Admin view)
            if (!globalInquiriesListener && db) {
                const inquiriesRef = getGlobalCollectionRef('inquiries');
                globalInquiriesListener = onSnapshot(inquiriesRef, (snapshot) => {
                    state.inquiries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentUser && activePage === 'customerService') renderCustomerServicePage();
                    if (currentUser && currentUser.isAdmin && activePage === 'admin') renderAdminInquiries();
                }, (error) => console.error("Global Inquiries Listener Error:", error));
            }
        };

        const setupUserListeners = (uid) => {
            if (!uid) return;

            // 1. User Farms Listener (Private)
            const farmsRef = getPrivateCollectionRef('farms', uid);
            if (farmsRef) {
                userFarmsListener = onSnapshot(farmsRef, (snapshot) => {
                    state.miningFarms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (activePage === 'myMiningFarm') renderMyMiningFarms();
                    if (activePage === 'coinWallet') renderCoinWallet();
                    if (activePage === 'withdrawalRequest') renderWithdrawalRequest();
                }, (error) => console.error("User Farms Listener Error:", error));
            }
            
            // 2. User Withdrawals Listener (Private)
            const withdrawalsRef = getPrivateCollectionRef('withdrawals', uid);
            if (withdrawalsRef) {
                userWithdrawalsListener = onSnapshot(withdrawalsRef, (snapshot) => {
                    state.withdrawals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (activePage === 'withdrawalRequest') renderWithdrawalRequest();
                }, (error) => console.error("User Withdrawals Listener Error:", error));
            }
            
            // 3. User Inquiries Listener (Private)
            const inquiriesRef = getPrivateCollectionRef('inquiries', uid);
             if (inquiriesRef) {
                userInquiriesListener = onSnapshot(inquiriesRef, (snapshot) => {
                    state.inquiries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (activePage === 'customerService') renderCustomerServicePage();
                }, (error) => console.error("User Inquiries Listener Error:", error));
            }
        };
        
        // --- Mining Logic ---
        
        const calculateMiningAmount = (farm) => {
            const rates = state.miningRates;
            const ratePerMin = rates[farm.miningType];
            if (!ratePerMin || ratePerMin <= 0) return farm.minedAmount;

            const now = Date.now();
            const lastUpdate = new Date(farm.lastUpdateTime).getTime();
            const elapsedTimeInMinutes = (now - lastUpdate) / (1000 * 60);

            if (elapsedTimeInMinutes <= 0) return farm.minedAmount;

            const newMinedAmount = farm.minedAmount + (elapsedTimeInMinutes * ratePerMin);
            return parseFloat(newMinedAmount.toFixed(6));
        };

        const updateFarmsInFirestore = async () => {
            if (!currentUser || !currentFirebaseUser) return;
            
            const farmsToUpdate = state.miningFarms.filter(farm => farm.isMining);

            if (farmsToUpdate.length === 0) return;

            const farmsRef = getPrivateCollectionRef('farms', currentUser.uid);
            
            // Batch updates or transactions would be better, but for simplicity, we use updateDoc in a loop with exponential backoff.
            
            for (const farm of farmsToUpdate) {
                const newMinedAmount = calculateMiningAmount(farm);
                const farmDocRef = doc(farmsRef, farm.id);
                
                try {
                    await updateDoc(farmDocRef, {
                        minedAmount: newMinedAmount,
                        lastUpdateTime: new Date().toISOString()
                    });
                } catch (error) {
                    console.error(`Failed to update farm ${farm.id}:`, error);
                }
            }
            // The UI will be updated by the 'userFarmsListener' upon successful update.
        };

        const startGlobalMiningInterval = () => {
            if (globalMiningInterval) clearInterval(globalMiningInterval);
            if (!currentUser) return;

            // Set a faster interval (e.g., 5 seconds) to trigger the actual calculation and Firestore update.
            globalMiningInterval = setInterval(updateFarmsInFirestore, 5000); 
        };
        
        const stopGlobalMiningInterval = () => {
            if (globalMiningInterval) {
                clearInterval(globalMiningInterval);
                globalMiningInterval = null;
            }
        };


        // --- Page Rendering Logic ---

        const showPage = (pageId) => {
            const isLoggedIn = !!currentUser;
            
            if (pageId === 'admin') {
                 if (!isLoggedIn || !currentUser.isAdmin) {
                    adminLoginModal.style.display = 'flex';
                    return;
                }
            } else if (['myMiningFarm', 'coinWallet', 'withdrawalRequest', 'openMiningFarm', 'customerService'].includes(pageId) && !isLoggedIn) {
                 showMessageModal('알림', '로그인 후 이용 가능합니다.');
                 return;
            }
            
            activePage = pageId; 
            pages.forEach(page => {
                if (pageElements[page]) {
                    pageElements[page].classList.add('hidden-page');
                }
            });
            if (pageElements[pageId]) {
                pageElements[pageId].classList.remove('hidden-page');
            }

            // Trigger an initial render based on in-memory state
            if (pageId === 'admin') {
                document.querySelectorAll('#admin-dashboard-area button[data-section]').forEach(btn => {
                     btn.classList.replace('bg-blue-600', 'bg-gray-800');
                     btn.classList.replace('text-white', 'text-gray-300');
                });
                document.querySelector('#admin-dashboard-area button[data-section="users"]').classList.replace('bg-gray-800', 'bg-blue-600');
                document.querySelector('#admin-dashboard-area button[data-section="users"]').classList.replace('text-gray-300', 'text-white');
                document.getElementById('users-section').classList.remove('hidden-page');

                adminSections.filter(s => s !== 'users').forEach(s => document.getElementById(`${s}-section`).classList.add('hidden-page'));

                renderAdminUsers();
                renderAdminPurchases(); 
                renderAdminWithdrawals();
                renderAdminInquiries();
                renderAdminMiningStatus();
                document.getElementById('silver-rate').value = state.miningRates['SILVER MINES'].toFixed(6);
                document.getElementById('gold-rate').value = state.miningRates['GOLD MINES'].toFixed(6);
                document.getElementById('diamond-rate').value = state.miningRates['DIAMOND MINES'].toFixed(6);
            } else if (pageId === 'myMiningFarm') {
                renderMyMiningFarms();
            } else if (pageId === 'coinWallet') {
                renderCoinWallet();
            } else if (pageId === 'withdrawalRequest') {
                renderWithdrawalRequest();
            } else if (pageId === 'customerService') {
                renderCustomerServicePage();
            }
        };

        const getFarmMiningStatus = (farm) => {
            if (!farm.isApproved) return { statusText: `<span class="text-yellow-400">입금대기</span>`, buttonHtml: `<button class="bg-gray-600 text-gray-300 px-3 py-1 rounded-lg text-sm cursor-not-allowed" disabled>입금대기</button>`, miningTime: '0초' };

            if (farm.isMining) {
                return { 
                    statusText: `<span class="text-green-400">채굴 중</span>`, 
                    buttonHtml: `<button class="btn-stop bg-red-600 text-white px-3 py-1 rounded-lg text-sm" data-farm-id="${farm.id}">채굴 중지</button>`,
                    miningTime: formatDuration(Date.now() - new Date(farm.startTime).getTime())
                };
            } else {
                return { 
                    statusText: `<span class="text-gray-500">중지됨</span>`, 
                    buttonHtml: `<button class="btn-start bg-green-600 text-white px-3 py-1 rounded-lg text-sm" data-farm-id="${farm.id}">채굴 시작</button>`,
                    miningTime: farm.stopTime && farm.startTime ? formatDuration(new Date(farm.stopTime).getTime() - new Date(farm.startTime).getTime()) : '0초'
                };
            }
        };

        // Render my mining farms on My Mining Farm page, grouped by type
        const renderMyMiningFarms = () => {
            const container = document.getElementById('my-mining-farms-container');
            container.innerHTML = '';

            if (!currentUser) {
                container.innerHTML = `<p class="text-center text-gray-500">로그인 후 채굴장 현황을 확인하세요.</p>`;
                return;
            }
            
            if (state.miningFarms.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500">보유 중인 채굴장이 없습니다. <button class="text-yellow-400 hover:underline" onclick="document.querySelector('button[data-page=\\'openMiningFarm\\']').click()">채굴장 개설</button> 페이지에서 구매해주세요.</p>`;
                 return;
            }

            const grades = ['SILVER MINES', 'GOLD MINES', 'DIAMOND MINES'];
            const gradeDisplayNames = { 'SILVER MINES': 'SILVER 등급 채굴장', 'GOLD MINES': 'GOLD 등급 채굴장', 'DIAMOND MINES': 'DIAMOND 등급 채굴장' };
            
            let totalFarmCount = 0;

            grades.forEach(grade => {
                const gradeFarms = state.miningFarms.filter(farm => farm.miningType === grade);
                totalFarmCount += gradeFarms.length;
                if (gradeFarms.length === 0) return;
                
                const gradeSection = document.createElement('div');
                gradeSection.classList.add('space-y-4');
                gradeSection.innerHTML = `
                    <h3 class="text-2xl font-bold text-yellow-400 border-b border-gray-700 pb-2 mb-4">${gradeDisplayNames[grade]} (${gradeFarms.length}개)</h3>
                `;

                const tableContainer = document.createElement('div');
                tableContainer.classList.add('overflow-x-auto');

                const table = document.createElement('table');
                table.classList.add('w-full', 'text-left', 'mining-farm-table');

                const tableHeader = `
                    <thead>
                        <tr class="text-gray-400 uppercase text-sm">
                            <th class="font-normal">채굴장 ID</th>
                            <th class="font-normal">상태</th>
                            <th class="font-normal">총 채굴량 (USDT)</th>
                            <th class="font-normal">채굴 시간</th>
                            <th class="font-normal">시작 시간</th>
                            <th class="font-normal">중지 시간</th>
                            <th class="font-normal">관리</th>
                        </tr>
                    </thead>
                `;

                const tableBody = document.createElement('tbody');
                
                gradeFarms.forEach((farm, index) => {
                    const status = getFarmMiningStatus(farm);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${farm.id}</td>
                        <td>${status.statusText}</td>
                        <td>${farm.minedAmount.toFixed(6)} USDT</td>
                        <td>${status.miningTime}</td>
                        <td>${farm.startTime ? formatDate(farm.startTime) : '미기록'}</td>
                        <td>${farm.stopTime ? formatDate(farm.stopTime) : '미기록'}</td>
                        <td>${status.buttonHtml}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                table.innerHTML = tableHeader;
                table.appendChild(tableBody);
                tableContainer.appendChild(table);
                gradeSection.appendChild(tableContainer);
                container.appendChild(gradeSection);
            });
            if (totalFarmCount === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500">보유 중인 채굴장이 없습니다. <button class="text-yellow-400 hover:underline" onclick="document.querySelector('button[data-page=\\'openMiningFarm\\']').click()">채굴장 개설</button> 페이지에서 구매해주세요.</p>`;
            }
        };

        // Render Coin Wallet page
        const renderCoinWallet = () => {
            const totalMinedElement = document.getElementById('total-mined-usdt');
            const krwEquivalentElement = document.getElementById('krw-equivalent');

            if (!currentUser) {
                totalMinedElement.textContent = '로그인 후 확인 가능';
                krwEquivalentElement.textContent = '';
                return;
            }
            
            const totalMined = state.miningFarms.reduce((sum, farm) => sum + farm.minedAmount, 0);
            
            // NOTE: Since we cannot fetch real-time USDT to KRW rate via API in this environment,
            // we will use a placeholder rate (e.g., 1 USDT = 1350 KRW) for display purposes.
            const usdtToKrwRate = 1350; 
            const krwEquivalent = totalMined * usdtToKrwRate;

            totalMinedElement.textContent = `${totalMined.toFixed(6)} USDT`;
            krwEquivalentElement.textContent = `(약 ₩${Math.round(krwEquivalent).toLocaleString('ko-KR')})`;
        };

        // Render Withdrawal Request page
        const renderWithdrawalRequest = () => {
            const availableUsdtElement = document.getElementById('available-usdt');
            const historyTableBody = document.getElementById('withdrawal-history-table-body');
            
            if (!currentUser) {
                availableUsdtElement.textContent = '0.000000 USDT';
                historyTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">로그인 후 확인 가능</td></tr>`;
                return;
            }
            
            const totalMined = state.miningFarms.reduce((sum, farm) => sum + farm.minedAmount, 0);

            const userRequests = state.withdrawals.filter(req => req.userId === currentUser.uid);
            const totalWithdrawnOrPending = userRequests.reduce((sum, req) => sum + req.amount, 0);

            const availableBalance = totalMined - totalWithdrawnOrPending;
            
            availableUsdtElement.textContent = `${availableBalance.toFixed(6)} USDT`;

            // Update withdrawal history
            userRequests.sort((a, b) => b.requestDate.localeCompare(a.requestDate)); // Show recent first
            historyTableBody.innerHTML = '';
            
            if (userRequests.length === 0) {
                historyTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-500">출금 요청 내역이 없습니다.</td></tr>`;
            } else {
                userRequests.forEach(req => {
                    const statusClass = req.status === '승인 완료' ? 'text-green-400' : 'text-yellow-400';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${req.requestDate}</td>
                        <td>${req.amount.toFixed(6)}</td>
                        <td><span class="${statusClass}">${req.status}</span></td>
                    `;
                    historyTableBody.appendChild(row);
                });
            }
        };
        
        // --- Admin Rendering Logic ---

        const renderAdminUsers = (usersToRender) => {
            if (!currentUser || !currentUser.isAdmin) return;
            const users = usersToRender || state.users;
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                let manageButtonHtml = user.isAdmin ? 
                    `<span class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">관리자</span>` : 
                    `<button class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm delete-user-btn" data-user-uid="${user.uid}">삭제</button>`;

                row.innerHTML = `
                    <td>${user.uid}</td>
                    <td><button class="text-yellow-400 hover:underline user-detail-link" data-user-uid="${user.uid}">${user.username}</button></td>
                    <td>${user.phone}</td>
                    <td>${user.signupDate}</td>
                    <td>${manageButtonHtml}</td>
                `;
                tableBody.appendChild(row);
            });
        };

        const renderAdminPurchases = () => {
            if (!currentUser || !currentUser.isAdmin) return;
            const tableBody = document.getElementById('purchase-table-body');
            tableBody.innerHTML = '';
            
            state.purchases.forEach(purchase => {
                const user = state.users.find(u => u.uid === purchase.userId);
                const username = user ? user.username : '알 수 없음';
                const row = document.createElement('tr');
                
                let buttonHtml = (purchase.status === '대기 중') ?
                    `<button class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm" data-purchase-id="${purchase.id}" data-action="approve">승인</button>` :
                    `<span class="text-green-400">승인 완료</span>`;
                buttonHtml += ` <button class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm" data-purchase-id="${purchase.id}" data-action="delete">삭제</button>`;

                row.innerHTML = `
                    <td class="text-xs">${purchase.userId}</td>
                    <td>${username}</td>
                    <td>${purchase.miningType}</td>
                    <td>${purchase.quantity}</td>
                    <td>${purchase.status}</td>
                    <td>${buttonHtml}</td>
                `;
                tableBody.appendChild(row);
            });
        };
        
        const renderAdminMiningStatus = () => {
            if (!currentUser || !currentUser.isAdmin) return;
            const tableBody = document.getElementById('mining-table-body');
            tableBody.innerHTML = '';

            state.users.forEach(user => {
                if (user.isAdmin) return; 
                const userFarms = state.miningFarms.filter(farm => farm.userId === user.uid);
                const totalMined = userFarms.reduce((sum, farm) => calculateMiningAmount(farm) , 0);
                const farmCount = userFarms.filter(farm => farm.isApproved).length;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-xs">${user.uid}</td>
                    <td>${user.username}</td>
                    <td>${farmCount} 개</td>
                    <td>${totalMined.toFixed(6)} USDT</td>
                `;
                tableBody.appendChild(row);
            });
        };

        const renderAdminWithdrawals = () => {
            if (!currentUser || !currentUser.isAdmin) return;
            const tableBody = document.getElementById('withdrawals-table-body');
            tableBody.innerHTML = '';
            
            state.withdrawals.forEach(req => {
                const user = state.users.find(u => u.uid === req.userId);
                const username = user ? user.username : '알 수 없음';
                const row = document.createElement('tr');
                
                let buttonHtml = (req.status === '대기 중') ?
                    `<button class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm" data-req-id="${req.id}" data-action="approve">승인</button>` :
                    `<span class="text-green-400">승인 완료</span>`;

                row.innerHTML = `
                    <td class="text-xs">${req.userId}</td>
                    <td>${username}</td>
                    <td>${req.amount.toFixed(6)} USDT</td>
                    <td>${req.walletAddress}</td>
                    <td>${req.status}</td>
                    <td>${req.requestDate}</td>
                    <td>${buttonHtml}</td>
                `;
                tableBody.appendChild(row);
            });
        };
        
        const renderAdminInquiries = (filterCategory = '전체') => {
            if (!currentUser || !currentUser.isAdmin) return;
            const container = document.getElementById('admin-inquiries-list');
            container.innerHTML = '';
            
            const filteredInquiries = filterCategory === '전체'
                ? state.inquiries
                : state.inquiries.filter(inq => inq.category === filterCategory);

            if (filteredInquiries.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500">해당 카테고리에 문의 내역이 없습니다.</p>`;
                 return;
            }

            filteredInquiries.sort((a, b) => b.createdAt.localeCompare(a.createdAt)).forEach(inquiry => {
                const inquiryCard = document.createElement('div');
                inquiryCard.className = 'card rounded-xl mb-4';

                const statusColor = inquiry.status === 'open' ? 'text-green-400' : 'text-gray-500';
                const statusText = inquiry.status === 'open' ? '답변 대기중' : '답변 완료';
                
                inquiryCard.innerHTML = `
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                        <div class="cursor-pointer inquiry-header flex-grow" data-inquiry-id="${inquiry.id}">
                            <p class="font-bold"><span class="text-sm bg-gray-700 text-yellow-400 px-2 py-1 rounded-full mr-2">${inquiry.category}</span>${inquiry.title}</p>
                            <p class="text-sm text-gray-400 mt-1">작성자: ${inquiry.username} (${inquiry.userId}) | 날짜: ${inquiry.createdAt}</p>
                        </div>
                        <div class="flex items-center gap-4 ml-4">
                            <span class="font-bold ${statusColor}">${statusText}</span>
                            <button class="delete-inquiry-btn bg-red-800 text-white px-3 py-1 rounded-lg text-xs hover:bg-red-700 btn" data-inquiry-id="${inquiry.id}">삭제</button>
                        </div>
                    </div>
                    <div class="p-4 hidden inquiry-content bg-gray-900/20" data-inquiry-id="${inquiry.id}">
                        <p class="font-bold mb-2">질문 내용:</p>
                        <p class="text-gray-300 whitespace-pre-wrap mb-4">${inquiry.question}</p>
                        <div class="replies-container space-y-4">
                            ${inquiry.replies.map(reply => `
                                <div class="flex items-start justify-between p-3 rounded-lg ${reply.isAdminReply ? 'bg-blue-900/50' : 'bg-gray-700/50'}">
                                    <div>
                                        <p class="font-bold text-sm ${reply.isAdminReply ? 'text-blue-300' : 'text-yellow-300'}">${reply.username} (${reply.createdAt})</p>
                                        <p class="text-gray-300 whitespace-pre-wrap mt-1">${reply.text}</p>
                                    </div>
                                    <button class="delete-reply-btn text-red-500 hover:text-red-400 font-bold text-lg ml-4 flex-shrink-0" data-inquiry-id="${inquiry.id}" data-reply-created-at="${reply.createdAt}">&times;</button>
                                </div>
                            `).join('')}
                        </div>
                        ${inquiry.status === 'open' ? `
                            <form class="admin-reply-form mt-4 space-y-2" data-inquiry-id="${inquiry.id}">
                                <textarea class="form-input" rows="3" placeholder="답변을 입력하세요..." required></textarea>
                                <div class="flex justify-end space-x-2">
                                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg btn">답변 등록</button>
                                    <button type="button" class="close-inquiry-btn bg-red-600 text-white font-bold py-2 px-4 rounded-lg btn" data-inquiry-id="${inquiry.id}">문의 종결</button>
                                </div>
                            </form>
                        ` : ''}
                    </div>
                `;
                container.appendChild(inquiryCard);
            });
        };

        const renderCustomerServicePage = () => {
            const inquiriesList = document.getElementById('inquiries-list');
            const formContainer = document.getElementById('inquiry-form-container');
            formContainer.classList.add('hidden');
            inquiriesList.innerHTML = '';
            
            if (!currentUser) {
                inquiriesList.innerHTML = `<p class="text-center text-gray-500">로그인 후 문의 내역을 확인하거나 새 문의를 작성할 수 있습니다.</p>`;
                document.getElementById('show-inquiry-form-btn').classList.add('hidden');
                return;
            }
            document.getElementById('show-inquiry-form-btn').classList.remove('hidden');

            const userInquiries = currentUser.isAdmin 
                ? state.inquiries.filter(i => i.userId !== currentFirebaseUser.uid) // Admin views all non-admin inquiries
                : state.inquiries.filter(inq => inq.userId === currentUser.uid);

            if (userInquiries.length === 0) {
                 inquiriesList.innerHTML = `<p class="text-center text-gray-500">작성한 문의 내역이 없습니다.</p>`;
            }
            
            userInquiries.sort((a, b) => b.createdAt.localeCompare(a.createdAt)).forEach(inquiry => { // Show recent first
                const inquiryCard = document.createElement('div');
                inquiryCard.className = 'card rounded-xl';

                const statusColor = inquiry.status === 'open' ? 'text-green-400' : 'text-gray-500';
                const statusText = inquiry.status === 'open' ? '답변 대기중' : '답변 완료';
                
                inquiryCard.innerHTML = `
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center cursor-pointer inquiry-header" data-inquiry-id="${inquiry.id}">
                        <div>
                             <p class="font-bold"><span class="text-sm bg-gray-700 text-yellow-400 px-2 py-1 rounded-full mr-2">${inquiry.category}</span>${inquiry.title}</p>
                            <p class="text-sm text-gray-400 mt-1">작성자: ${inquiry.username} (${inquiry.userId}) | 날짜: ${inquiry.createdAt}</p>
                        </div>
                        <span class="font-bold ${statusColor}">${statusText}</span>
                    </div>
                    <div class="p-4 hidden inquiry-content bg-gray-900/20" data-inquiry-id="${inquiry.id}">
                        <p class="font-bold mb-2">질문 내용:</p>
                        <p class="text-gray-300 whitespace-pre-wrap mb-4">${inquiry.question}</p>
                        <div class="replies-container space-y-4">
                            ${inquiry.replies.map(reply => `
                                <div class="p-3 rounded-lg ${reply.isAdminReply ? 'bg-blue-900/50' : 'bg-gray-700/50'}">
                                    <p class="font-bold text-sm ${reply.isAdminReply ? 'text-blue-300' : 'text-yellow-300'}">${reply.username} (${reply.createdAt})</p>
                                    <p class="text-gray-300 whitespace-pre-wrap mt-1">${reply.text}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                inquiriesList.appendChild(inquiryCard);
            });
        };

        const showUserDetails = (userUid) => {
            const user = state.users.find(u => u.uid === userUid);
            if (!user) return;
            
            const isSelf = currentUser && currentUser.uid === userUid;
            const isAdminViewing = currentUser && currentUser.isAdmin && !isSelf;

            // Clear password fields and message
            document.getElementById('password-change-user-uid').value = userUid;
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            document.getElementById('password-change-message').classList.add('hidden');
            
            // Toggle password change section visibility
            document.getElementById('password-change-section').style.display = isAdminViewing ? 'block' : 'none';

            // Basic Info
            document.getElementById('detail-uid').textContent = user.uid;
            document.getElementById('detail-username').textContent = user.username;
            document.getElementById('detail-password').textContent = user.password;
            document.getElementById('detail-phone').textContent = user.phone;
            document.getElementById('detail-signup-date').textContent = user.signupDate;

            // Farm Info
            const userFarms = state.miningFarms.filter(farm => farm.userId === userUid);
            const farmsContainer = document.getElementById('detail-farms');
            farmsContainer.innerHTML = '';
            
            const farmsByGrade = userFarms.reduce((acc, farm) => {
                (acc[farm.miningType] = acc[farm.miningType] || []).push(farm);
                return acc;
            }, {});

            const grades = ['SILVER MINES', 'GOLD MINES', 'DIAMOND MINES'];
            grades.forEach(grade => {
                const farms = farmsByGrade[grade] || [];
                const gradeDiv = document.createElement('div');
                gradeDiv.classList.add('mb-2');
                
                const farmListHtml = farms.map((farm, index) => {
                    return `<li class="text-gray-400 text-xs">NO: ${farm.id}, 상태: ${farm.isApproved ? (farm.isMining ? '채굴 중' : '중지') : '대기'}</li>`;
                }).join('');
                
                gradeDiv.innerHTML = `
                    <p class="text-sm"><strong>${grade}:</strong> ${farms.length}개 보유</p>
                    ${farms.length > 0 ? `<ul class="list-disc list-inside text-sm pl-4">${farmListHtml}</ul>` : ''}
                `;
                farmsContainer.appendChild(gradeDiv);
            });

            // Coin Info
            const totalMined = userFarms.reduce((sum, farm) => calculateMiningAmount(farm), 0);

            const userWithdrawals = state.withdrawals.filter(w => w.userId === userUid);
            const totalWithdrawnApproved = userWithdrawals
                .filter(w => w.status === '승인 완료')
                .reduce((sum, req) => sum + req.amount, 0);
            
            const totalWithdrawnOrPending = userWithdrawals.reduce((sum, req) => sum + req.amount, 0);

            const balance = totalMined - totalWithdrawnOrPending;

            document.getElementById('detail-total-mined').textContent = `${totalMined.toFixed(6)} USDT`;
            document.getElementById('detail-total-withdrawn').textContent = `${totalWithdrawnApproved.toFixed(6)} USDT`;
            document.getElementById('detail-balance').textContent = `${balance.toFixed(6)} USDT`;

            userDetailsModal.style.display = 'flex';
        };

        // --- Event Handlers ---
        
        // General page navigation
        document.querySelectorAll('nav button').forEach(button => {
            button.addEventListener('click', () => showPage(button.dataset.page));
        });

        // Auth Modals
        loginBtn.addEventListener('click', () => { modalTitle.textContent = '로그인'; loginForm.classList.remove('hidden'); signupForm.classList.add('hidden'); authModal.style.display = 'flex'; modalMessage.classList.add('hidden'); });
        signupBtn.addEventListener('click', () => { modalTitle.textContent = '회원가입'; loginForm.classList.add('hidden'); signupForm.classList.remove('hidden'); authModal.style.display = 'flex'; modalMessage.classList.add('hidden'); });
        closeModalBtn.addEventListener('click', () => { authModal.style.display = 'none'; });
        document.getElementById('message-modal-close').addEventListener('click', closeMessageModal);
        document.getElementById('message-modal-confirm-btn').addEventListener('click', closeMessageModal);
        closeAdminModalBtn.addEventListener('click', () => { adminLoginModal.style.display = 'none'; document.getElementById('admin-modal-message').classList.add('hidden'); });
        document.getElementById('admin-page-link').addEventListener('click', (e) => { e.preventDefault(); showPage('admin'); });
        closeUserDetailsModalBtn.addEventListener('click', () => { userDetailsModal.style.display = 'none'; });
        memberInfoBtn.addEventListener('click', () => { if (currentUser) showUserDetails(currentUser.uid); });


        // Login/Signup Handlers
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const result = await loginUser(username, password, false);
            
            if (result.success) {
                authModal.style.display = 'none';
                showMessageModal('로그인 성공', `환영합니다, ${result.user.username}님!`);
            } else {
                modalMessage.textContent = result.message;
                modalMessage.classList.remove('hidden');
            }
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-password-confirm').value;
            const phone = document.getElementById('signup-phone').value;
            const usersRef = USERS_COLLECTION_REF;
            
            if (password !== confirmPassword) { modalMessage.textContent = '비밀번호가 일치하지 않습니다.'; modalMessage.classList.remove('hidden'); return; }
            if (username.toLowerCase() === 'admin') { modalMessage.textContent = '이 아이디는 사용할 수 없습니다.'; modalMessage.classList.remove('hidden'); return; }
            
            try {
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) { modalMessage.textContent = '이미 사용 중인 아이디입니다.'; modalMessage.classList.remove('hidden'); return; }

                const userDocRef = doc(usersRef, currentFirebaseUser.uid);
                await setDoc(userDocRef, {
                    uid: currentFirebaseUser.uid,
                    id: generateDisplayUserId(currentFirebaseUser.uid), // Custom ID for display
                    username,
                    password,
                    phone,
                    signupDate: new Date().toLocaleDateString('ko-KR'),
                    isAdmin: false
                });

                modalMessage.textContent = '회원가입이 완료되었습니다. 로그인 해주세요!';
                modalMessage.classList.remove('hidden');
                
                // Switch to login form
                signupForm.reset();
                setTimeout(() => {
                    modalMessage.classList.add('hidden');
                    modalTitle.textContent = '로그인'; 
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                }, 1500);

            } catch (error) {
                 console.error("Signup Error:", error);
                 modalMessage.textContent = `회원가입 중 오류 발생: ${error.message}`;
                 modalMessage.classList.remove('hidden');
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('admin-login-username').value;
            const password = document.getElementById('admin-login-password').value;
            const adminModalMessage = document.getElementById('admin-modal-message');

            const result = await loginUser(username, password, true);
            
            if (result.success) {
                adminLoginModal.style.display = 'none';
                adminModalMessage.classList.add('hidden');
                showPage('admin');
            } else {
                adminModalMessage.textContent = result.message;
                adminModalMessage.classList.remove('hidden');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            stopGlobalMiningInterval();
            currentUser = null;
            updateAuthUI();
            
            // Note: We don't sign out from Firebase entirely, we just update the UI state.
            // A full sign out would require re-signing in anonymously later.
            // await signOut(auth); 
            
            showPage('home');
            showMessageModal('로그아웃', '성공적으로 로그아웃되었습니다.');
        });
        
        // Purchase handler
        document.querySelectorAll('#openMiningFarm-page .purchase-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                if (!currentUser) { showMessageModal('알림', '로그인 후 이용 가능합니다.'); return; }
                const card = e.target.closest('.card');
                const miningType = e.target.dataset.type;
                const quantity = parseInt(card.querySelector('.purchase-quantity').value, 10);
                
                if (quantity <= 0) { showMessageModal('오류', '수량은 1개 이상이어야 합니다.'); return; }
                
                try {
                    const purchaseId = Date.now().toString() + Math.random().toString(36).substring(2, 7);
                    
                    // 1. Add Purchase Request (Global visibility for Admin, for Approval)
                    const purchasesRef = getGlobalCollectionRef('purchases');
                    await addDoc(purchasesRef, {
                        userId: currentUser.uid,
                        username: currentUser.username,
                        miningType,
                        quantity: quantity,
                        date: new Date().toLocaleDateString('ko-KR'),
                        status: '대기 중'
                    });

                    // 2. Create unapproved farm documents (Private for User, to link upon approval)
                    const farmsRef = getPrivateCollectionRef('farms', currentUser.uid);
                    for (let i = 0; i < quantity; i++) {
                        await addDoc(farmsRef, {
                            purchaseId: purchaseId,
                            userId: currentUser.uid,
                            miningType: miningType,
                            minedAmount: 0.0,
                            isMining: false,
                            isApproved: false,
                            startTime: null,
                            stopTime: null,
                            lastUpdateTime: new Date().toISOString()
                        });
                    }
                    
                    showMessageModal('구매 신청 완료', `${miningType} ${quantity}개 구매 신청이 완료되었습니다. 관리자 승인을 기다려주세요.`);
                } catch (error) {
                    console.error("Purchase Error:", error);
                    showMessageModal('오류', '구매 신청 중 오류가 발생했습니다.');
                }
            });
        });

        // Withdrawal handler
        document.getElementById('withdrawal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const walletAddress = document.getElementById('wallet-address').value;
            
            const totalMined = state.miningFarms.reduce((sum, farm) => calculateMiningAmount(farm), 0);
            const userRequests = state.withdrawals.filter(req => req.userId === currentUser.uid);
            const totalWithdrawnOrPending = userRequests.reduce((sum, req) => sum + req.amount, 0);
            const availableBalance = totalMined - totalWithdrawnOrPending;
            
            if (amount < 35) { showMessageModal('오류', '최소 출금 가능 금액은 35 USDT입니다.'); return; }
            if (amount > availableBalance) { showMessageModal('오류', '사용 가능 금액보다 많은 금액을 출금할 수 없습니다.'); return; }

            try {
                 // Withdrawal Request is globally visible for Admin approval
                const withdrawalsRef = getGlobalCollectionRef('withdrawals');
                await addDoc(withdrawalsRef, {
                    userId: currentUser.uid,
                    username: currentUser.username,
                    amount,
                    walletAddress,
                    status: '대기 중',
                    requestDate: new Date().toLocaleDateString('ko-KR')
                });

                showMessageModal('출금 요청 완료', '출금 요청이 성공적으로 접수되었습니다. 관리자 승인을 기다려주세요.');
                document.getElementById('withdrawal-form').reset();
            } catch (error) {
                console.error("Withdrawal Request Error:", error);
                showMessageModal('오류', '출금 요청 중 오류가 발생했습니다.');
            }
        });
        
        // Start/Stop mining handler
        document.addEventListener('click', async (e) => {
            if (!currentUser || !currentFirebaseUser) return;

            if (e.target.matches('.btn-start, .btn-stop')) {
                const farmId = e.target.dataset.farmId;
                const isStart = e.target.classList.contains('btn-start');
                
                const farmsRef = getPrivateCollectionRef('farms', currentUser.uid);
                const farmDocRef = doc(farmsRef, farmId);
                
                const farm = state.miningFarms.find(f => f.id === farmId);
                if (!farm || !farm.isApproved) {
                    showMessageModal('오류', '아직 승인되지 않은 채굴장입니다. 관리자에게 문의하세요.');
                    return;
                }
                
                const now = new Date().toISOString();
                
                try {
                    await updateDoc(farmDocRef, {
                        isMining: isStart,
                        startTime: isStart ? now : (farm.startTime || now),
                        stopTime: isStart ? null : now,
                        lastUpdateTime: now,
                        minedAmount: calculateMiningAmount(farm) // Finalize current mining amount before stopping
                    });
                } catch (error) {
                    console.error("Mining toggle error:", error);
                    showMessageModal('오류', '채굴 상태 변경 중 오류가 발생했습니다.');
                }
            }
        });

        // Admin: Update Mining Rates
        document.getElementById('update-mining-rate-btn').addEventListener('click', async () => {
             if (!currentUser || !currentUser.isAdmin) { showMessageModal('권한 없음', '관리자만 접근할 수 있습니다.'); return; }

            const rates = {
                silverRate: parseFloat(document.getElementById('silver-rate').value) || 0,
                goldRate: parseFloat(document.getElementById('gold-rate').value) || 0,
                diamondRate: parseFloat(document.getElementById('diamond-rate').value) || 0
            };
            
            try {
                await setDoc(CONFIG_DOC_REF, rates, { merge: true });
                const message = document.getElementById('mining-rate-message');
                message.textContent = '채굴량이 성공적으로 업데이트되었습니다.';
                message.classList.remove('hidden', 'text-red-400');
                message.classList.add('text-green-400');
                setTimeout(() => message.classList.add('hidden'), 3000);
            } catch (error) {
                console.error("Rate update error:", error);
                const message = document.getElementById('mining-rate-message');
                message.textContent = '업데이트 중 오류 발생!';
                message.classList.remove('hidden', 'text-green-400');
                message.classList.add('text-red-400');
                setTimeout(() => message.classList.add('hidden'), 3000);
            }
        });
        
        // Admin: Section navigation
        document.querySelectorAll('#admin-dashboard-area button[data-section]').forEach(button => {
            button.addEventListener('click', () => {
                const sectionId = button.dataset.section;
                document.querySelectorAll('#admin-dashboard-area button[data-section]').forEach(btn => {
                     btn.classList.replace('bg-blue-600', 'bg-gray-800');
                     btn.classList.replace('text-white', 'text-gray-300');
                });
                button.classList.replace('bg-gray-800', 'bg-blue-600');
                button.classList.replace('text-gray-300', 'text-white');

                adminSections.forEach(section => {
                    const sectionElement = document.getElementById(`${section}-section`);
                    if (sectionElement) {
                        sectionElement.classList.add('hidden-page');
                    }
                });
                const targetSection = document.getElementById(`${sectionId}-section`);
                if (targetSection) {
                    targetSection.classList.remove('hidden-page');
                }
                
                // Re-render data for the active section (listeners keep data up to date)
                if (sectionId === 'users') renderAdminUsers();
                else if (sectionId === 'purchase') renderAdminPurchases();
                else if (sectionId === 'withdrawals') renderAdminWithdrawals();
                else if (sectionId === 'inquiries') renderAdminInquiries();
                else if (sectionId === 'mining') renderAdminMiningStatus();
            });
        });
        
        // Admin: Purchase/Withdrawal action handlers
        document.addEventListener('click', async (e) => {
            if (!currentUser || !currentUser.isAdmin) return;
            const target = e.target;

            // Purchase Approval/Deletion
            if (target.matches('#purchase-table-body button[data-action]')) {
                const purchaseId = target.dataset.purchaseId;
                const action = target.dataset.action;
                
                // Use a transaction for atomic update across collections
                try {
                    await runTransaction(db, async (transaction) => {
                        const purchasesRef = getGlobalCollectionRef('purchases');
                        const purchaseQuery = query(purchasesRef, where('purchaseId', '==', purchaseId));
                        const purchaseSnapshot = await transaction.get(purchaseQuery);
                        if (purchaseSnapshot.empty) throw new Error("Purchase document not found.");
                        
                        const purchaseDocRef = purchaseSnapshot.docs[0].ref;
                        const purchaseData = purchaseSnapshot.docs[0].data();
                        
                        const farmsRef = getPrivateCollectionRef('farms', purchaseData.userId);
                        const farmsQuery = query(farmsRef, where('purchaseId', '==', purchaseId));
                        const farmsSnapshot = await transaction.get(farmsQuery);

                        if (action === 'approve') {
                            transaction.update(purchaseDocRef, { status: '승인 완료' });
                            farmsSnapshot.docs.forEach(farmDoc => {
                                transaction.update(farmDoc.ref, { 
                                    isApproved: true,
                                    id: farmDoc.id // Set the farm ID to the document ID for UI use
                                });
                            });
                        } else if (action === 'delete') {
                             transaction.delete(purchaseDocRef);
                             farmsSnapshot.docs.forEach(farmDoc => {
                                 transaction.delete(farmDoc.ref);
                             });
                        }
                    });
                    
                    showMessageModal('처리 완료', action === 'approve' ? '구매 신청이 승인되었습니다.' : '구매 신청이 삭제되었습니다.');
                } catch (error) {
                    console.error("Purchase Admin Action Error:", error);
                    showMessageModal('오류', `처리 중 오류 발생: ${error.message}`);
                }
            }
            
            // Withdrawal Approval
            if (target.matches('#withdrawals-table-body button[data-action="approve"]')) {
                const reqId = target.dataset.reqId;
                try {
                    const withdrawalsRef = getGlobalCollectionRef('withdrawals');
                    await updateDoc(doc(withdrawalsRef, reqId), { status: '승인 완료' });
                    showMessageModal('승인', '출금 요청이 승인되었습니다.');
                } catch (error) {
                    console.error("Withdrawal Approval Error:", error);
                    showMessageModal('오류', '출금 요청 승인 중 오류가 발생했습니다.');
                }
            }

            // Admin: Delete User
            if (target.matches('.delete-user-btn')) {
                const userUid = target.dataset.userUid;
                try {
                    const userDocRef = doc(USERS_COLLECTION_REF, userUid);
                    await deleteDoc(userDocRef);
                    showMessageModal('삭제', '회원 정보가 삭제되었습니다.');
                } catch (error) {
                    console.error("User Deletion Error:", error);
                    showMessageModal('오류', '회원 삭제 중 오류가 발생했습니다.');
                }
            }
        });
        
        // Admin: Password change handler (only for admin viewing other user details)
        document.getElementById('change-password-btn').addEventListener('click', async () => {
            if (!currentUser || !currentUser.isAdmin) return;
            const userUid = document.getElementById('password-change-user-uid').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const messageEl = document.getElementById('password-change-message');

            messageEl.classList.remove('hidden');
            if (!newPassword || !confirmPassword) { messageEl.textContent = '새 비밀번호를 입력해주세요.'; messageEl.className = 'text-center text-sm mt-2 text-red-400'; return; }
            if (newPassword !== confirmPassword) { messageEl.textContent = '비밀번호가 일치하지 않습니다.'; messageEl.className = 'text-center text-sm mt-2 text-red-400'; return; }
            
            try {
                const userDocRef = doc(USERS_COLLECTION_REF, userUid);
                await updateDoc(userDocRef, { password: newPassword });
                
                // Update the state locally for immediate display
                const userIndex = state.users.findIndex(u => u.uid === userUid);
                if (userIndex > -1) state.users[userIndex].password = newPassword;

                document.getElementById('detail-password').textContent = newPassword;
                messageEl.textContent = '비밀번호가 성공적으로 변경되었습니다.';
                messageEl.className = 'text-center text-sm mt-2 text-green-400';

                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';
                setTimeout(() => { messageEl.classList.add('hidden'); }, 3000);
            } catch (error) {
                messageEl.textContent = '비밀번호 변경 중 오류 발생.';
                messageEl.className = 'text-center text-sm mt-2 text-red-400';
            }
        });
        
        // Admin: Inquiry management handlers (Reply, Close, Delete)
        document.getElementById('admin-page').addEventListener('submit', async (e) => {
            if (!currentUser || !currentUser.isAdmin) return;

            if (e.target.matches('.admin-reply-form')) {
                e.preventDefault();
                const inquiryId = e.target.dataset.inquiryId;
                const replyText = e.target.querySelector('textarea').value;
                const inquiriesRef = getGlobalCollectionRef('inquiries');
                const inquiryDocRef = doc(inquiriesRef, inquiryId);

                try {
                    await updateDoc(inquiryDocRef, {
                        replies: [
                            ...state.inquiries.find(i => i.id === inquiryId).replies,
                            {
                                username: '관리자',
                                isAdminReply: true,
                                text: replyText,
                                createdAt: new Date().toLocaleDateString('ko-KR')
                            }
                        ]
                    });
                    e.target.reset(); // Clear form
                } catch (error) {
                    console.error("Admin Reply Error:", error);
                    showMessageModal('오류', '답변 등록 중 오류가 발생했습니다.');
                }
            }
        });

        document.getElementById('admin-page').addEventListener('click', async (e) => {
            if (!currentUser || !currentUser.isAdmin) return;
            const target = e.target;
            
            if (target.matches('.close-inquiry-btn')) {
                const inquiryId = target.dataset.inquiryId;
                const inquiriesRef = getGlobalCollectionRef('inquiries');
                const inquiryDocRef = doc(inquiriesRef, inquiryId);
                try {
                    await updateDoc(inquiryDocRef, { status: 'closed' });
                } catch (error) { console.error("Close Inquiry Error:", error); }
            } else if (target.matches('.delete-inquiry-btn')) {
                const inquiryId = target.dataset.inquiryId;
                const inquiriesRef = getGlobalCollectionRef('inquiries');
                const inquiryDocRef = doc(inquiriesRef, inquiryId);
                try {
                    await deleteDoc(inquiryDocRef);
                    showMessageModal('삭제 완료', '문의 내역이 삭제되었습니다.');
                } catch (error) { console.error("Delete Inquiry Error:", error); }
            } else if (target.matches('.delete-reply-btn')) {
                 const inquiryId = target.dataset.inquiryId;
                 const replyCreatedAt = target.dataset.replyCreatedAt;
                 const inquiriesRef = getGlobalCollectionRef('inquiries');
                 const inquiryDocRef = doc(inquiriesRef, inquiryId);
                 
                 const inquiry = state.inquiries.find(i => i.id === inquiryId);
                 if (!inquiry) return;

                 const updatedReplies = inquiry.replies.filter(reply => reply.createdAt !== replyCreatedAt);

                 try {
                     await updateDoc(inquiryDocRef, { replies: updatedReplies });
                     showMessageModal('삭제 완료', '문의 답변이 삭제되었습니다.');
                 } catch (error) {
                     console.error("Delete Reply Error:", error);
                     showMessageModal('오류', '답변 삭제 중 오류가 발생했습니다.');
                 }
            }
        });
        
        // Inquiry Form Handlers
        document.getElementById('show-inquiry-form-btn').addEventListener('click', () => {
            document.getElementById('inquiry-form-container').classList.remove('hidden');
        });
        document.getElementById('cancel-inquiry-btn').addEventListener('click', () => {
             document.getElementById('inquiry-form-container').classList.add('hidden');
        });
        
        document.getElementById('inquiry-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const category = document.getElementById('inquiry-category').value;
            const title = document.getElementById('inquiry-title').value;
            const question = document.getElementById('inquiry-question').value;
            
            try {
                const inquiriesRef = getGlobalCollectionRef('inquiries');
                await addDoc(inquiriesRef, {
                    userId: currentUser.uid,
                    username: currentUser.username,
                    category,
                    title,
                    question,
                    status: 'open',
                    createdAt: new Date().toLocaleDateString('ko-KR'),
                    replies: []
                });

                showMessageModal('문의 접수', '새로운 문의가 성공적으로 접수되었습니다.');
                document.getElementById('inquiry-form').reset();
                document.getElementById('inquiry-form-container').classList.add('hidden');
            } catch (error) {
                console.error("Inquiry Submission Error:", error);
                showMessageModal('오류', '문의 접수 중 오류가 발생했습니다.');
            }
        });


        // --- Initialization and Auth State Change ---

        const bootstrapApp = () => { 
            // Ensure Firestore and Auth are ready before proceeding
            if (!db || !auth) {
                console.error("Firebase services not initialized. Retrying in 1 second.");
                setTimeout(bootstrapApp, 1000);
                return;
            }

            setupGlobalListeners(); 

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentFirebaseUser = user;
                    // 1. Try to fetch user profile from Firestore
                    const userDoc = await getDocs(query(USERS_COLLECTION_REF, where('uid', '==', user.uid)));
                    
                    if (!userDoc.empty) {
                        currentUser = { ...userDoc.docs[0].data(), uid: user.uid };
                        console.log("User profile loaded:", currentUser.username);
                        setupUserListeners(user.uid);
                        updateAuthUI();
                        startGlobalMiningInterval();
                        // If user is admin, force load admin data (which is handled by global listeners)
                        if (currentUser.isAdmin) {
                            renderAdminUsers(); // Rerender admin view with loaded data
                        }
                    } else {
                        // User is signed in (anonymously or via token) but hasn't created a custom account (or it's the admin setup time)
                        currentUser = null; 
                        updateAuthUI();
                        // If it's a new anonymous session, create a default admin user if one doesn't exist
                        checkAndCreateAdminUser(user.uid);
                    }
                } else {
                     // Fallback to anonymous sign-in if no token provided or sign out
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                }
            });
        };

        const checkAndCreateAdminUser = async (uid) => {
             // Check if 'admin' user exists in Firestore
             const adminQuery = query(USERS_COLLECTION_REF, where("username", "==", 'admin'));
             const adminSnapshot = await getDocs(adminQuery);

             if (adminSnapshot.empty) {
                 // Create the default admin account only if it doesn't exist
                 const adminUserDocRef = doc(USERS_COLLECTION_REF, uid);
                 await setDoc(adminUserDocRef, {
                    uid: uid,
                    id: generateDisplayUserId(uid),
                    username: 'admin',
                    password: 'admin12',
                    phone: '000-0000-0000',
                    signupDate: new Date().toLocaleDateString('ko-KR'),
                    isAdmin: true
                 });
                 console.log("Default admin account created.");
             }
        };

        // Mobile Menu Logic
        mobileMenuButton.addEventListener('click', () => { mobileMenu.classList.remove('hidden'); });
        closeMobileMenu.addEventListener('click', () => { mobileMenu.classList.add('hidden'); });


        window.onload = bootstrapApp;

    </script>
</body>
</html>
